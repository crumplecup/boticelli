# Discord Post Generation Carousel
# Five narratives that each generate-critique-refine a single post
# Each narrative auto-stores to potential_discord_posts table at completion
#
# Usage:
#   Single post:  just narrate generation_carousel.feature
#   Batch of 50:  just narrate generation_carousel.batch_generate

# === Shared Composition Acts (reference other narratives) ===
[acts.feature]
narrative = "feature"

[acts.usecase]
narrative = "usecase"

[acts.tutorial]
narrative = "tutorial"

[acts.community]
narrative = "community"

[acts.problem]
narrative = "problem"

# === Batch Generator: Run all five narratives in carousel mode ===
[narrative.batch_generate]
toc = ["feature", "usecase", "tutorial", "community", "problem"]

[narrative.batch_generate.carousel]
iterations = 3

# === Shared Model Configuration ===
[config.gemini]
model = "gemini-2.5-flash-lite"
temperature = 0.8
max_tokens = 20000

# === Shared Resources ===

# Load Botticelli context for the LLM
[media.context]
file = "BOTTICELLI_CONTEXT.md"

# === Shared Act Definitions ===

[acts.critique]
model = "gemini-2.5-flash-lite"
temperature = 0.3
max_tokens = 4000

[[acts.critique.input]]
type = "text"
content = """
Critique this Discord post for content quality:

{{generate}}

Evaluate:
1. Engagement (hook, CTA)
2. Clarity (structure, readability)
3. Accuracy (matches Botticelli capabilities)
4. Discord formatting (markdown, emojis)
5. Length (under 1800 chars)

Provide specific, actionable improvements.
"""

[acts.refine]
model = "gemini-2.5-flash-lite"
temperature = 0.7
max_tokens = 4000

[[acts.refine.input]]
type = "text"
content = """
Improve the post based on critique. Focus on content quality, not JSON formatting.

Original: {{generate}}

Critique: {{critique}}

Output the improved post text (plain text, no JSON yet):
"""

[acts.format_json]
model = "gemini-2.5-flash-lite"
temperature = 0.1
max_tokens = 4000

[[acts.format_json.input]]
type = "text"
content = """
Format this content as valid JSON matching this exact schema.

Content to format:
{{refine}}

Required Schema:
{
  "text_content": string (required, 10-2000 characters),
  "content_type": string (optional, defaults to "discord_post"),
  "source": string (optional, e.g., "generation_carousel"),
  "tags": array of strings (optional, relevant keywords),
  "status": string (required, always set to "pending")
}

CRITICAL RULES:
1. Output ONLY the JSON object - no markdown blocks (```json), no explanations, no surrounding text
2. Start your response with { and end with }
3. Use exact field names (text_content not textContent)
4. Ensure all strings are properly quoted and escaped
5. Arrays must have proper comma separation
6. Do not truncate - complete the JSON fully
7. text_content must be a plain string, not a nested object

Example output format:
{
  "text_content": "Your Discord post content here...",
  "content_type": "discord_post",
  "source": "generation_carousel",
  "tags": ["feature", "automation", "ai"]
}

Now format the content above as JSON.
"""

[acts.audit_json]
model = "gemini-2.5-flash-lite"
temperature = 0.1
max_tokens = 4000

[[acts.audit_json.input]]
type = "text"
content = """
Audit this JSON for schema compliance and fix any issues.

JSON to audit:
{{format_json}}

Required Schema:
{
  "text_content": string (required, 10-2000 characters),
  "content_type": string (optional),
  "source": string (optional),
  "tags": array of strings (optional)
}

VALIDATION CHECKLIST:
- ✓ Starts with { and ends with } (no markdown blocks)
- ✓ All field names use snake_case (text_content not textContent)
- ✓ text_content is a plain string (not nested object)
- ✓ All values match their types (string, array, etc.)
- ✓ No extra fields outside the schema
- ✓ No explanatory text before or after JSON
- ✓ JSON is complete (not truncated mid-string)

CRITICAL RULES:
1. Output ONLY the JSON object - no markdown (```json), no explanations
2. Start with { and end with }
3. If valid, output it unchanged
4. If invalid, output the corrected version
5. Ensure all strings are properly quoted and escaped
6. Do not truncate - complete the JSON fully

Example valid output:
{
  "text_content": "Your Discord post content here...",
  "content_type": "discord_post",
  "source": "generation_carousel",
  "tags": ["feature", "automation"]
}

Now audit the JSON above and output the valid/corrected version.
"""

# === Shared Act: Feature Generate ===
[acts.feature_generate]
model = "gemini-2.5-flash-lite"
temperature = 0.8
max_tokens = 2000

[[acts.feature_generate.input]]
type = "text"
file = "BOTTICELLI_CONTEXT.md"

[[acts.feature_generate.input]]
type = "text"
content = """
Read the Botticelli context document above. Use this information to create an engaging Discord post.

Focus: Feature showcase
Angle: Highlight a specific Botticelli capability

Requirements:
- Length: Under 1800 characters
- Format: Discord markdown (**, *, __, ~~, ||) with emojis
- Structure: Hook, explanation, example, call-to-action
- Tone: Enthusiastic but professional
- Tags: Include "feature" plus relevant feature names

Write the post text (plain text, we'll format as JSON later):
"""

# === Narrative 1: Feature Showcase ===
[narrative.feature]
target = "potential_discord_posts"
toc = ["feature_generate", "critique", "refine", "format_json", "audit_json"]

# === Shared Act: Usecase Generate ===
[acts.usecase_generate]
model = "gemini-2.5-flash-lite"
temperature = 0.8
max_tokens = 2000

[[acts.usecase_generate.input]]
type = "text"
file = "BOTTICELLI_CONTEXT.md"

[[acts.usecase_generate.input]]
type = "text"
content = """
Read the Botticelli context document above. Use this information to create an engaging Discord post.

Focus: Real-world use cases
Angle: Show practical applications

Requirements:
- Length: Under 1800 characters
- Format: Discord markdown (**, *, __, ~~, ||) with emojis
- Structure: Hook, explanation, example, call-to-action
- Tone: Enthusiastic but professional
- Tags: Include "usecase" plus relevant application domains

Write the post text (plain text, we'll format as JSON later):
"""

# === Narrative 2: Use Cases ===
[narrative.usecase]
target = "potential_discord_posts"
toc = ["usecase_generate", "critique", "refine", "format_json", "audit_json"]

# === Shared Act: Tutorial Generate ===
[acts.tutorial_generate]
model = "gemini-2.5-flash-lite"
temperature = 0.8
max_tokens = 2000

[[acts.tutorial_generate.input]]
type = "text"
file = "BOTTICELLI_CONTEXT.md"

[[acts.tutorial_generate.input]]
type = "text"
content = """
Read the Botticelli context document above. Use this information to create an engaging Discord post.

Focus: Tutorial or how-to guide
Angle: Educational, step-by-step

Requirements:
- Length: Under 1800 characters
- Format: Discord markdown (**, *, __, ~~, ||) with emojis
- Structure: Hook, explanation, example, call-to-action
- Tone: Enthusiastic but professional
- Tags: Include "tutorial" plus relevant topics

Write the post text (plain text, we'll format as JSON later):
"""

# === Narrative 3: Tutorial ===
[narrative.tutorial]
target = "potential_discord_posts"
toc = ["tutorial_generate", "critique", "refine", "format_json", "audit_json"]

# === Shared Act: Community Generate ===
[acts.community_generate]
model = "gemini-2.5-flash-lite"
temperature = 0.8
max_tokens = 2000

[[acts.community_generate.input]]
type = "text"
file = "BOTTICELLI_CONTEXT.md"

[[acts.community_generate.input]]
type = "text"
content = """
Read the Botticelli context document above. Use this information to create an engaging Discord post.

Focus: Community engagement
Angle: Encourage participation, questions, sharing

Requirements:
- Length: Under 1800 characters
- Format: Discord markdown (**, *, __, ~~, ||) with emojis
- Structure: Hook, explanation, example, call-to-action
- Tone: Enthusiastic but professional
- Tags: Include "community" plus engagement type

Write the post text (plain text, we'll format as JSON later):
"""

# === Narrative 4: Community ===
[narrative.community]
target = "potential_discord_posts"
toc = ["community_generate", "critique", "refine", "format_json", "audit_json"]

# === Shared Act: Problem Generate ===
[acts.problem_generate]
model = "gemini-2.5-flash-lite"
temperature = 0.8
max_tokens = 2000

[[acts.problem_generate.input]]
type = "text"
file = "BOTTICELLI_CONTEXT.md"

[[acts.problem_generate.input]]
type = "text"
content = """
Read the Botticelli context document above. Use this information to create an engaging Discord post.

Focus: Problem-solution narrative
Angle: Common challenges Botticelli solves

Requirements:
- Length: Under 1800 characters
- Format: Discord markdown (**, *, __, ~~, ||) with emojis
- Structure: Hook, explanation, example, call-to-action
- Tone: Enthusiastic but professional
- Tags: Include "problem_solution" plus relevant problem domains

Write the post text (plain text, we'll format as JSON later):
"""

# === Narrative 5: Problem-Solution ===
[narrative.problem]
target = "potential_discord_posts"
toc = ["problem_generate", "critique", "refine", "format_json", "audit_json"]
