# JSON Compliance Narrative
# Ensures content conforms to JSON schema through format → audit → parse cycle

[shared]
model = "gemini-2.0-flash-exp"

# Reusable acts for JSON compliance workflow
[act.format_json]
type = "generate"
prompt = """
Reformat the following content to match this JSON schema exactly:

Schema:
{schema}

Content to format:
{content}

Output ONLY valid JSON matching the schema. No markdown, no explanations, just the JSON object.
"""

[act.audit_json]
type = "generate"
prompt = """
Audit this JSON for compliance with the schema and fix any issues:

Schema:
{schema}

JSON to audit:
{json}

If the JSON is valid, output it unchanged. If there are issues, output the corrected JSON.
Output ONLY valid JSON. No markdown, no explanations.
"""

# JSON Compliance Narrative
# Takes raw content and schema, outputs validated JSON
[[narrative]]
name = "ensure_json_compliance"
description = "Format and validate content against JSON schema"
toc = ["format_json", "audit_json"]

[narrative.context]
schema = """
{
  "title": "string (required, 1-100 chars)",
  "text_content": "string (required, 10-2000 chars)",
  "media_urls": ["string (optional, valid URLs)"],
  "tags": ["string (optional, relevant keywords)"],
  "target_channel": "string (optional, channel name)"
}
"""
content = "{previous_output}"  # Pipe from previous narrative

[narrative.output]
target_table = "potential_discord_posts"
mode = "inference"
